<div class="container mt-4">
  <!-- Кнопка назад и заголовок -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <%= link_to root_path, class: 'btn btn-outline-secondary' do %>
        <i class="bi bi-arrow-left"></i> Назад
      <% end %>
    </div>
    <h1 class="mb-0">Бекап в файлы</h1>
    <div style="width: 120px;"></div> 
  </div>
  
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Создать новый бекап</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <%= form_tag backups_path, method: :post, class: 'row g-3' do %>
              <div class="col-md-6">
                <label class="form-label">Формат:</label>
                <select name="format" class="form-select" required>
                  <option value="json" selected>JSON</option>
                  <option value="yaml">YAML</option>
                </select>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <%= submit_tag 'Создать бекап', 
                    class: 'btn btn-primary w-100',
                    data: { confirm: 'Создать бекап всех данных?' } %>
              </div>
            <% end %>
          </div>
        </div>
        
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Загрузить бекап-файл</h5>
        </div>
        <div class="col-md-6">
          <%= form_tag upload_backups_path, multipart: true, class: 'mt-2' do %>
            <div class="input-group">
              <%= file_field_tag :backup_file, class: 'form-control', accept: '.json,.yaml,.yml', required: true %>
              <%= submit_tag 'Загрузить', class: 'btn btn-success' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0">Существующие бекапы</h5>
    </div>
    <div class="card-body">
      <% if @backups.empty? %>
        <div class="text-center py-4">
          <p class="text-muted mb-0">Файлы бекапа не найдены.</p>
        </div>
      <% else %>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Название файла</th>
                <th>Формат</th>
                <th>Размер</th>
                <th>Создан</th>
                <th class="text-center">Действия</th>
              </tr>
            </thead>
            <tbody>
              <% @backups.each do |backup| %>
                <%
                  filepath = Rails.root.join('storage', 'backups', backup)
                  file_exists = File.exist?(filepath)
                  file_size = file_exists ? number_to_human_size(File.size(filepath)) : 'N/A'
                  created_at = file_exists ? File.mtime(filepath) : nil
                  backup_id = backup.gsub(/\.(json|yaml|yml)$/, '')
                %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <code class="me-2"><%= backup %></code>
                      <% unless file_exists %>
                        <span class="badge bg-warning">Файл отсутствует</span>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <% if backup.end_with?('.json') %>
                      <span class="badge bg-primary">JSON</span>
                    <% elsif backup.end_with?('.yaml', '.yml') %>
                      <span class="badge bg-info text-dark">YAML</span>
                    <% end %>
                  </td>
                  <td><%= file_size %></td>
                  <td>
                    <% if created_at %>
                      <%= l(created_at, format: :short) %>
                    <% else %>
                      N/A
                    <% end %>
                  </td>
                  <td class="text-center">
                    <div class="btn-group" role="group" style="flex-wrap: nowrap; gap: 5px;">
                      <% if file_exists %>
                        <%= link_to download_backup_path(backup_id), 
                            class: 'btn btn-sm btn-outline-primary d-flex align-items-center',
                            title: 'Download backup file',
                            style: 'min-width: 80px; justify-content: center;' do %>
                          <i class="bi bi-download me-1"></i> Загрузить
                        <% end %>
                        
                        <form action="<%= restore_backup_path(backup_id) %>" method="post" 
                              style="display: inline;"
                              onsubmit="return confirm('ВНИМАНИЕ: Это действие удалит ВСЕ текущие записи из базы данных. Это действие нельзя будет вернуть. Продолжить?');">
                          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                          <button type="submit" 
                                  class="btn btn-sm btn-outline-warning d-flex align-items-center"
                                  title="Восстановить базу данных из бекапа"
                                  style="min-width: 80px; justify-content: center;">
                            <i class="bi bi-arrow-clockwise me-1"></i> Восстановить
                          </button>
                        </form>
                        
                        <form action="<%= backup_path(backup_id) %>" method="post" 
                              style="display: inline;"
                              onsubmit="return confirm('Вы уверены что хотите удалить данный бекап-файл?');">
                          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                          <input type="hidden" name="_method" value="delete">
                          <button type="submit" 
                                  class="btn btn-sm btn-outline-danger d-flex align-items-center"
                                  title="Delete backup file"
                                  style="min-width: 80px; justify-content: center;">
                            <i class="bi bi-trash me-1"></i> Удалить
                          </button>
                        </form>
                      <% else %>
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center" disabled 
                                style="min-width: 80px; justify-content: center;">
                          <i class="bi bi-download me-1"></i> Download
                        </button>
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center" disabled
                                style="min-width: 80px; justify-content: center;">
                          <i class="bi bi-arrow-clockwise me-1"></i> Restore
                        </button>
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center" disabled
                                style="min-width: 80px; justify-content: center;">
                          <i class="bi bi-trash me-1"></i> Delete
                        </button>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
  
</div>

<style>
  /* Стили для кнопок */
  .btn-group .btn, .btn-group form {
    flex: 0 0 auto;
  }
  
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
  }
  
  code {
    font-size: 0.85em;
    background-color: #f8f9fa;
    padding: 3px 6px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  }
  
  .table th {
    font-weight: 600;
    vertical-align: middle;
  }
  
  .badge {
    font-size: 0.75em;
    padding: 0.25em 0.6em;
    font-weight: 500;
  }
  
  /* Стили для иконок в кнопках */
  .btn i {
    font-size: 0.9em;
  }
  
  /* Адаптивность для мобильных устройств */
  @media (max-width: 768px) {
    .btn-group {
      flex-direction: column;
      gap: 5px;
    }
    
    .btn-group .btn, .btn-group form {
      width: 100%;
    }
    
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 15px;
    }
    
    .d-flex.justify-content-between > div {
      width: 100%;
      text-align: center;
    }
    
    .table-responsive {
      font-size: 0.9em;
    }
  }
</style>