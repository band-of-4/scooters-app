<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Scooter Rental" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Scooter Rental">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>
  <body>
    <%= yield %>
  </body>
<script>
(function() {
  'use strict';
  
  let isProcessing = false;
  
  function init() {
    document.addEventListener('keyup', handleKeyUp);
  }
  
  function handleKeyUp(e) {
    if (e.target.matches('input, textarea, select')) return;
    if (isProcessing) return;
    
    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
      e.preventDefault();
      sendAction('undo');
    } else if (e.ctrlKey && e.key === 'y') {
      e.preventDefault();
      sendAction('redo');
    }
  }
  
  async function sendAction(action) {
    isProcessing = true;
    
    try {
      const token = document.querySelector('meta[name="csrf-token"]')?.content;
      const controller = window.location.pathname.split("/").filter(part => part.length > 0)[0];
      
      if (!controller || !token) return;
      
      const response = await fetch(`/${controller}/${action}`, {
        method: 'POST',
        headers: { 'X-CSRF-Token': token }
      });
      
      if (response.redirected) {
        window.location.href = response.url;
      }
    } finally {
      isProcessing = false;
    }
  }
  
  // Только обычная загрузка, без Turbo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>
</html>
